#!/bin/bash

BACKUPS_DIR="/srv/backups"
BACKUP_DIR="${BACKUPS_DIR}/vault"

# Stop the Vault server before taking a backup
# FIXME: We should migrate to a PostgreSQL backend to be able to take online backups and still avoid creating a complete
#         Raft cluster.
# systemctl stop vault

# Create a temporary directory used to create the backup
TIMESTAMP=$(date +'%Y-%m-%d_%Hh%M')
TMP_BACKUP_DIR="/tmp/vault"
rm -Rf "${TMP_BACKUP_DIR}"

# Copy the Vault data
echo "Copying Vault data..."
mkdir -p "${TMP_BACKUP_DIR}/opt/vault"
cp -R /opt/vault/data "${TMP_BACKUP_DIR}/opt/vault"
chown -R vault:vault "${TMP_BACKUP_DIR}/opt/vault"

# Copy the Vault configuration
echo "Copying Vault configuration..."
mkdir -p "${TMP_BACKUP_DIR}/etc/vault.d"
cp -R /etc/vault.d/* "${TMP_BACKUP_DIR}/etc/vault.d"
chown -R vault:vault "${TMP_BACKUP_DIR}/etc/vault.d"

# Create the final backup archive
echo "Creating backup archive..."
mkdir -p "${BACKUP_DIR}"
tar -czf "${BACKUP_DIR}/vault-${TIMESTAMP}.tar.gz" -C "${TMP_BACKUP_DIR}" .

# Ensure we never have more than 7 snapshots
echo "Keeping only last 7 backups..."
find "${BACKUP_DIR}" -type f -name "vault-*.tar.gz" -printf '%T+ %p\n' | sort | head -n -7 | awk '{print $2}' | xargs -I {} rm {}

# Remove the backup from the temporary location
echo "Cleaning up temporary files..."
rm -Rf "${TMP_BACKUP_DIR}"

# Restart the Vault server after the backup is complete
# FIXME: See above comment about online backups.
# systemctl start vault
