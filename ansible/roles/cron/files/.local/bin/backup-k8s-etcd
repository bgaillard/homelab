#!/bin/bash

BACKUPS_DIR="/srv/backups"
BACKUP_DIR="${BACKUPS_DIR}/k8s-etcd"

INCUS_PROJECT="k8s"

ETCD_NODE_HOSTNAME="etcd-1"
ETCD_NODE_IP="10.0.0.11"
ETCD_SNAPSHOT_FILE="etcd-snapshot-$(date +'%Y-%m-%d_%Hh%M').db"

RESTIC=/home/baptiste/.local/bin/restic-k8s-etcd

# Create the snapshot on the etcd-1 node
incus exec --project "${INCUS_PROJECT}" "${ETCD_NODE_HOSTNAME}" -- /usr/bin/etcdctl snapshot save \
  --cert /etc/kubernetes/pki/etcd/peer.crt \
  --key /etc/kubernetes/pki/etcd/peer.key \
  --cacert /etc/kubernetes/pki/etcd/ca.crt  \
  --endpoints "https://${ETCD_NODE_IP}:2379" "/tmp/${ETCD_SNAPSHOT_FILE}"

# Pull the snapshot to the homelab server
mkdir -p "${BACKUP_DIR}"
incus file pull --project ${INCUS_PROJECT} --recursive --create-dirs \
  "${ETCD_NODE_HOSTNAME}/tmp/${ETCD_SNAPSHOT_FILE}" "${BACKUP_DIR}/${ETCD_SNAPSHOT_FILE}"

# Ensure we never have more than 7 snapshots
find "${BACKUPS_DIR}" -type f -name "etcd-snapshot-*.db" -printf '%T+ %p\n' | sort | head -n -7 | awk '{print $2}' | xargs -I {} rm {}

# Backup the snapshot with restic
${RESTIC} backup "${BACKUP_DIR}"

# Remove the snapshot from the homelab server
incus exec --project "${INCUS_PROJECT}" "${ETCD_NODE_HOSTNAME}" -- rm "/tmp/${ETCD_SNAPSHOT_FILE}"

# Keep the last 7 backups in restic
${RESTIC} forget --keep-last 7 --prune
