---
# @see https://linuxcontainers.org/incus/docs/main/installing/
- name: Install 'incus' APT packages
  ansible.builtin.package:
    name:
      - incus
      - incus-base
    state: latest

- name: Add the user '{{ ansible_facts['env']['USER'] }}' to the 'incus-admin' group
  become: true
  ansible.builtin.user:
    name: "{{ ansible_facts['env']['USER'] }}"
    shell: /bin/bash
    group: "{{ ansible_facts['env']['USER'] }}"
    groups: incus-admin
    append: true
    state: present

- name: Initialize incus
  become: true
  ansible.builtin.shell:
    stdin: |
      config: 
        core.https_address: "{{ ansible_facts['default_ipv4']['address'] }}:8443"
      networks: []
      storage_pools: []
      storage_volumes: []
      profiles:
      - config: {}
        description: Default Incus profile
        devices: {}
        name: default
        project: ""
      projects:
      - config:
          features.images: "true"
          features.networks: "true"
          features.networks.zones: "true"
          features.profiles: "true"
          features.storage.buckets: "true"
          features.storage.volumes: "true"
        description: Default Incus project
        name: default
    cmd: incus admin init --preseed
