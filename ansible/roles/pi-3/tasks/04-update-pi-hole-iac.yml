---
- name: Create the '~/.github' directory if it does not exist
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.github"
    state: directory
    mode: '0700'

- name: Create the '~/.local/bin' directory if it does not exist
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
    state: directory
    mode: '0700'

- name: Write the Github Iac Updater private key to the '~/.github/iac-updater.private-key.pem' file
  ansible.builtin.copy:
    content: "{{ iac_updater_private_key }}"
    dest: "{{ ansible_facts['env']['HOME'] }}/.github/iac-updater.private-key.pem"
    mode: '0600'

- name: Install the required Python pip packages
  ansible.builtin.pip:
    break_system_packages: true
    name:
      # Required by the 'update-pi-hole-iac.py' script
      - hvac
      - PyJWT
      - cryptography
    executable: pip3
    state: present

- name: Configure the 'pi-hole-iac-updater' Vault AppRole role
  block:
    - name: Create the 'pi-hole-iac-updater' Vault policy
      delegate_to: localhost
      community.hashi_vault.vault_write:
        token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        url: "{{ lookup('env', 'VAULT_ADDR') }}"
        path: "sys/policy/pi-hole-iac-updater"
        data:
          policy: |
            path "kv/data/pi-hole" {
              capabilities = ["read", "patch", "update"]
            }

    - name: Create or update the 'pi-hole-iac-updater' Vault AppRole role
      delegate_to: localhost
      community.hashi_vault.vault_write:
        token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        url: "{{ lookup('env', 'VAULT_ADDR') }}"
        path: "auth/approle/role/pi-hole-iac-updater"
        data:
          role_name: "pi-hole-iac-updater"
          bind_secret_id: true
          secret_id_bound_cidrs:
            - "192.168.1.0/24"
          secret_id_num_uses: 0
          secret_id_ttl: "0"
          token_ttl: "30s"
          token_max_ttl: "120s"
          token_policies:
            - "pi-hole-iac-updater"
          token_bound_cidrs:
            - "192.168.1.0/24"
          token_explicit_max_ttl: "120s"
          token_no_default_policy: true
          token_type: "batch"

    - name: Get the 'pi-hole-iac-updater' Vault AppRole role ID
      delegate_to: localhost
      community.hashi_vault.vault_read:
        token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        url: "{{ lookup('env', 'VAULT_ADDR') }}"
        path: "auth/approle/role/pi-hole-iac-updater/role-id"
      register: vault_pi_hole_iac_updater_approle_role_id

    - name: List the secret ID accessors for the 'pi-hole-iac-updater' Vault AppRole
      delegate_to: localhost
      community.hashi_vault.vault_list:
        token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        url: "{{ lookup('env', 'VAULT_ADDR') }}"
        path: "auth/approle/role/pi-hole-iac-updater/secret-id"
      register: vault_pi_hole_iac_updater_approle_secret_id_accessors

    - name: Cleanup all the secret IDs
      delegate_to: localhost
      community.hashi_vault.vault_write:
        token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        url: "{{ lookup('env', 'VAULT_ADDR') }}"
        path: "auth/approle/role/pi-hole-iac-updater/secret-id-accessor/destroy"
        data:
          secret_id_accessor: "{{ item }}"
      loop: "{{ vault_pi_hole_iac_updater_approle_secret_id_accessors.data.data.get('keys') }}"

    - name: Generate a new secret ID for the 'pi-hole-iac-updater' Vault AppRole
      delegate_to: localhost
      community.hashi_vault.vault_write:
        token: "{{ lookup('env', 'VAULT_TOKEN') }}"
        url: "{{ lookup('env', 'VAULT_ADDR') }}"
        path: "auth/approle/role/pi-hole-iac-updater/secret-id"
        data:
          cidr_list:
            - "192.168.1.0/24"
          token_bound_cidrs:
            - "192.168.1.0/24"
          num_uses: 0
          ttl: "0"
      register: vault_pi_hole_iac_updater_approle_secret_id

    - name: Create the '~/.vault' directory if it does not exist
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.vault"
        state: directory
        mode: '0700'

    - name: Write the 'pi-hole-iac-updater' Vault AppRole credentials to the '~/.vault/approle-pi-hole-iac-updater.json' file
      ansible.builtin.copy:
        content: |
          {
            "role_id": "{{ vault_pi_hole_iac_updater_approle_role_id.data.data.role_id }}",
            "secret_id": "{{ vault_pi_hole_iac_updater_approle_secret_id.data.data.secret_id }}"
          }
        dest: "{{ ansible_facts['env']['HOME'] }}/.vault/approle-pi-hole-iac-updater.json"
        mode: '0600'

- name: Copy file '~/.local/bin/update-pi-hole-iac.py'
  ansible.builtin.copy:
    src: home/baptiste/.local/bin/update-pi-hole-iac.py
    dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/update-pi-hole-iac.py"
    mode: u=rx
    force: true

- name: Create the '/var/log/update-pi-hole-iac/' directory if it does not exist
  become: true
  ansible.builtin.file:
    path: "/var/log/update-pi-hole-iac/"
    state: directory
    owner: "{{ ansible_facts['env']['USER'] }}"
    group: "{{ ansible_facts['env']['USER'] }}"
    mode: '0700'

- name: Configure the 'update-pi-hole-iac' cron job
  become: true
  ansible.builtin.cron:
    name: "Update Pi-hole IAC"
    job: "IAC_UPDATER_CLIENT_ID={{ iac_updater_client_id }} IAC_UPDATER_INSTALLATION_ID={{ iac_updater_installation_id }} IAC_UPDATER_PRIVATE_KEY_PATH={{ ansible_facts['env']['HOME'] }}/.github/iac-updater.private-key.pem PI_HOLE_PASSWORD={{ pi_hole_app_password }} {{ ansible_facts['env']['HOME'] }}/.local/bin/update-pi-hole-iac.py >> /var/log/update-pi-hole-iac/update-pi-hole-iac.log 2>&1"
    state: present
    user: "{{ ansible_facts['env']['USER'] }}"
    minute: "0"
    hour: "6"
    weekday: "*"
    month: "*"
    day: "*"
